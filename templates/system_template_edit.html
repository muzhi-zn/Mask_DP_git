
<!DOCTYPE html>
<!--[if lt IE 7]> <html lang="en" class="lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>    <html lang="en" class="lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>    <html lang="en" class="lt-ie9"> <![endif]-->
<!--[if IE 9]>    <html lang="en" class="ie9"> <![endif]-->
<!--[if gt IE 9]><!--> <html lang="en"> <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
    <title>Nestable</title>
<link href= "{{ static ('bootstrap3/css/bootstrap.min.css') }}" rel="stylesheet">
<link href= "{{ static ('bootstrap3/font-awesome/css/font-awesome.css') }}" rel="stylesheet">
	<link href= "{{ static ('bootstrap3/css/animate.css') }}" rel="stylesheet">
	<link href= "{{ static ('bootstrap3/css/style.css') }}" rel="stylesheet">
	<link href= "{{ static ('bootstrap3/css/plugins/codemirror/codemirror.css') }}" rel="stylesheet">
	
	
    <style type="text/css">


/**
 * Nestable
 */

.dd { position: relative; display: block; margin: 0; padding: 0; max-width: 1000px; list-style: none; font-size: 13px; line-height: 20px; }

.dd-list { display: block; position: relative; margin: 0; padding: 0; list-style: none; }
.dd-list .dd-list { padding-left: 30px; }
.dd-collapsed .dd-list { display: none; }

.dd-item,
.dd-empty,
.dd-placeholder { display: block; position: relative; margin: 0; padding: 0; min-height: 20px; font-size: 13px; line-height: 20px; }

.dd-handle { display: block; height: 30px; margin: 5px 0; padding: 5px 10px; color: #333; text-decoration: none; font-weight: bold; border: 1px solid #ccc;
    background: #fafafa;
    background: -webkit-linear-gradient(top, #fafafa 0%, #eee 100%);
    background:    -moz-linear-gradient(top, #fafafa 0%, #eee 100%);
    background:         linear-gradient(top, #fafafa 0%, #eee 100%);
    -webkit-border-radius: 3px;
            border-radius: 3px;
    box-sizing: border-box; -moz-box-sizing: border-box;
}
.dd-handle:hover { color: #2ea8e5; background: #fff; }

.dd-item > button { display: block; position: relative; cursor: pointer; float: left; width: 25px; height: 20px; margin: 5px 0; padding: 0; text-indent: 100%; white-space: nowrap; overflow: hidden; border: 0; background: transparent; font-size: 12px; line-height: 1; text-align: center; font-weight: bold; }
.dd-item > button:before { content: '+'; display: block; position: absolute; width: 100%; text-align: center; text-indent: 0; }
.dd-item > button[data-action="collapse"]:before { content: '-'; }

.dd-placeholder,
.dd-empty { margin: 5px 0; padding: 0; min-height: 30px; background: #f2fbff; border: 1px dashed #b6bcbf; box-sizing: border-box; -moz-box-sizing: border-box; }
.dd-empty { border: 1px dashed #bbb; min-height: 100px; background-color: #e5e5e5;
    background-image: -webkit-linear-gradient(45deg, #fff 25%, transparent 25%, transparent 75%, #fff 75%, #fff),
                      -webkit-linear-gradient(45deg, #fff 25%, transparent 25%, transparent 75%, #fff 75%, #fff);
    background-image:    -moz-linear-gradient(45deg, #fff 25%, transparent 25%, transparent 75%, #fff 75%, #fff),
                         -moz-linear-gradient(45deg, #fff 25%, transparent 25%, transparent 75%, #fff 75%, #fff);
    background-image:         linear-gradient(45deg, #fff 25%, transparent 25%, transparent 75%, #fff 75%, #fff),
                              linear-gradient(45deg, #fff 25%, transparent 25%, transparent 75%, #fff 75%, #fff);
    background-size: 60px 60px;
    background-position: 0 0, 30px 30px;
}

.dd-dragel { position: absolute; pointer-events: none; z-index: 9999; }
.dd-dragel > .dd-item .dd-handle { margin-top: 0; }
.dd-dragel .dd-handle {
    -webkit-box-shadow: 2px 4px 6px 0 rgba(0,0,0,.1);
            box-shadow: 2px 4px 6px 0 rgba(0,0,0,.1);
}

/**
 * Nestable Extras
 */

.nestable-lists { display: block; clear: both; padding: 30px 0; width: 100%; border: 0; border-top: 2px solid #ddd; border-bottom: 2px solid #ddd; }

#nestable-menu { padding: 0; margin: 20px 0; }

#nestable-output,
#nestable2-output { width: 100%; height: 7em; font-size: 0.75em; line-height: 1.333333em; font-family: Consolas, monospace; padding: 5px; box-sizing: border-box; -moz-box-sizing: border-box; }

#nestable2 .dd-handle {
    color: #fff;
    border: 1px solid #999;
    background: #bbb;
    background: -webkit-linear-gradient(top, #bbb 0%, #999 100%);
    background:    -moz-linear-gradient(top, #bbb 0%, #999 100%);
    background:         linear-gradient(top, #bbb 0%, #999 100%);
}
#nestable2 .dd-handle:hover { background: #bbb; }
#nestable2 .dd-item > button:before { color: #fff; }

@media only screen and (min-width: 1000px) {

    .dd { float: left; width: 80%;  }
    .dd + .dd { margin-left: 2%; }

}

.dd-hover > .dd-handle { background: #2ea8e5 !important; }

/**
 * Nestable Draggable Handles
 */

.dd3-content { display: block;  margin: 5px 0; padding: 5px 5px 5px 40px; color: #333; text-decoration: none; font-weight: bold; border: 1px solid #ccc;
    background: #fafafa;
    background: -webkit-linear-gradient(top, #fafafa 0%, #eee 100%);
    background:    -moz-linear-gradient(top, #fafafa 0%, #eee 100%);
    background:         linear-gradient(top, #fafafa 0%, #eee 100%);
    -webkit-border-radius: 3px;
            border-radius: 3px;
    box-sizing: border-box; -moz-box-sizing: border-box;
}
.dd3-content:hover { color: #2ea8e5; background: #fff; }

.dd-dragel > .dd3-item > .dd3-content { margin: 0; }

.dd3-item > button { margin-left: 30px; }

.dd3-handle { position: absolute; margin: 0; left: 0; top: 0; cursor: pointer; width: 30px; text-indent: 100%; white-space: nowrap; overflow: hidden;
    border: 1px solid #aaa;
    background: #ddd;
    background: -webkit-linear-gradient(top, #ddd 0%, #bbb 100%);
    background:    -moz-linear-gradient(top, #ddd 0%, #bbb 100%);
    background:         linear-gradient(top, #ddd 0%, #bbb 100%);
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
}
.dd3-handle:before { content: '≡'; display: block; position: absolute; left: 0; top: 3px; width: 100%; text-align: center; text-indent: 0; color: #fff; font-size: 20px; font-weight: normal; }
.dd3-handle:hover { background: #ddd; }

/**
 * Socialite
 */

.socialite { display: block; float: left; height: 35px; }

.del-right {position: absolute; right: 5px; top: 3px;}
.edit-right {position: absolute; right: 50px; top: 3px;}
    </style>
	
	
</head>
<body style="background-color: white;padding: 5px;">
	<form id="searchForm" class="form-horizontal"  method="post" autocomplete="off">
		<input type ="hidden" name ="csrfmiddlewaretoken" value ="{{csrf_token}}">
		<input id="template_type" name="template_type"  type="hidden" />
		<input id="dict_type" name="dict_type"  type="hidden" value="{{template.dict_type or ''}}" />
		
	</form>
	
	<form id="inputForm" class="form-horizontal" action="/system/role/{{method}}/" method="post" autocomplete="off">
	<input type ="hidden" name ="csrfmiddlewaretoken" value ="{{csrf_token}}">
	
<table class="table table-bordered  table-condensed dataTables-example dataTable no-footer">
				   <tbody>
						<tr>
							<td class="width-15 active"><label class="pull-right"><font color="red">*</font>Template Type:</label></td>
							<td class="width-40">
								<select id="filename_select"  class="form-control m-b required " onchange="changeFileName();">
									<option value="">Select Template Type</option>
									{% for it in template_list %}
									<option value="{{it.value}}" {% if template.template_type == it.label %} selected {% endif %} >{{it.label}}</option>
									{% endfor %}
									</select>
									<input id="templateType" name="templateType"  type="hidden" value="{{template.template_type or ''}}"/>
									<input id="dictType" name="dictType"  type="hidden" value="{{template.dict_type or ''}}" />
									
							</td>
							
							<td class="width-15 active"><label class="pull-right"><font color="red">*</font>Template Name:</label></td>
							<td class="width-35">
								<input id="templateName" name="templateName" class="form-control required " type="text" value="{{template.template_name or ''}}" maxlength="200"/>
								
							</td>
							
							
						</tr>
						<tr>
							
						</tr>
						<tr>
							
							<td class="width-15 active" ><label class="pull-right"><font color="red">*</font>File Name</label></td>
							<td class="width-35" colspan="3">
								<input id="fileName" name="fileName" class="form-control required " type="text" value="{{template.file_name or ''}}" maxlength="200"/>
								
							</td>
							
						</tr>
						<tr><td class="width-15 active">
								File Name Var
							</td>
							<td class="width-35">
								<select id="file_name_list_select" >
									<option value="">Select...</option>
									{% for it in dict_list %}
									<option value="{{it.value}}">{{it.label}}</option>
									{% endfor %}
													  
								</select>
							</td>
							<td class="width-15 active" colspan="2">
									<input type="button" class="btn btn-primary" id="insertToNameBtn" value="Insert" onclick="insertToName();" />
													
								</td>
								</tr>
						
					</tbody>
				</table>
				<input id="templateJson" name="templateJson" type="hidden" value="{{template.template_json}}"/>
				<input id="id" name="id" type="hidden" value="{{template.id}}"/>
				
				
  </form>
  <!-- 修改数据的界面  开始-->
  <div class="modal inmodal"   id="row-edit" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog" style="width: 900px;">
      <div class="modal-content animated bounceInRight" >
              <div class="modal-header"  style="padding: 2px; >
                  <h4 class="modal-title" style="height: 20px;">Edit Row</h4>
              </div>
              <div class="modal-body" style="padding: 5px; " >
				  <div class="form-group"  >
				  <select id="list_select" >
					  <option value="">Select...</option>
					  {% for it in dict_list %}
					  <option value="{{it.value}}">{{it.label}}</option>
					  {% endfor %}
				  </select>
				  <input type="button" class="btn btn-primary" id="insertInfotree" value="Insert" onclick="insertInfotree();" />
				 
				  
				  <input type="button" class="btn btn-primary" id="undo" value="UnDo" onclick="undo();" />
				  <input type="button" class="btn btn-primary" id="redo" value="ReDo" onclick="redo();" />
				  
				  </div>
                  <div  id="coder-div"  >
				  </div>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-white" data-dismiss="modal">Cancel</button>
                  <button type="button" class="btn btn-primary" onclick="saveRow();">Save</button>
              </div>
          </div>
      </div>
  </div>
<!-- 修改数据的界面  结束-->
  

    <menu id="nestable-menu">
        <button type="button" class="btn btn-primary"  data-action="add-row" >Add Row</button>
		
    </menu>

   
    <div class="cf nestable-lists">

   
   
        <div class="dd" id="nestable">
            <ol id ="J_List" class="dd-list">
               {% for dict in row_dict %}
			   <li class="dd-item dd3-item" data-id="1" data-value="{{dict.value}}" ><div class="dd-handle dd3-handle"></div>
			   <div class="dd3-content">
				   <span class="input-value">{% autoescape false %}{{dict.value|replace('\n','</BR>')}}{% endautoescape %}</span>
				   <a  class="del-right" href="javascrip:;" onclick="delInfo(this);" title="Delete">Del</a><a class="edit-right" href="javascrip:;" onclick="editInfo(this)" title="Edit">Edit</a></div></li>
               {% endfor %} 
            </ol>
        </div>

    </div>

   
   <!-- Mainly scripts -->
   <script src= "{{ static ('bootstrap3/js/jquery-2.1.1.js') }}"></script>
   <script src= "{{ static ('bootstrap3/js/bootstrap.min.js') }}"></script>
   <script src= "{{ static ('bootstrap3/js/plugins/metisMenu/jquery.metisMenu.js') }}"></script>
   <script src= "{{ static ('bootstrap3/js/plugins/slimscroll/jquery.slimscroll.min.js') }}"></script>
   <!-- CodeMirror -->
    <script src= "{{ static ('bootstrap3/js/plugins/codemirror/codemirror.js') }}"></script>
    <script src= "{{ static ('bootstrap3/js/plugins/codemirror/mode/javascript/javascript.js') }}"></script>
   {% include 'base.html' %}
   <script src= "{{ static ('js/jquery.nestable.js') }}"></script>
   	
<script>
	//全局变量，存放要编辑行对象
	var edit_obj = null;
	//定义代码编辑器变量
	var code_editer = null;	
	
	$(document).ready(function()
	{
		var coder_div = $("#coder-div");
		var coder = '<textarea id="coder" style="height:500px;"  class="form-control" rows="60"></textarea>';
				  
		coder_div.html(coder);
		code_editer = CodeMirror.fromTextArea(document.getElementById("coder"), {
						 lineNumbers: true,
						 autofocus: true,
						 matchBrackets: true,
						 styleActiveLine: true
					 });
		code_editer.setSize('auto','400px');				 
	    var updateOutput = function(e)
	    {
	        var list   = e.length ? e : $(e.target),
	            output = list.data('output');
	        
			if (window.JSON) {
	            //output.val(window.JSON.stringify(list.nestable('serialize')));//, null, 2));
				output.val(window.JSON.stringify(list.nestable('serialize')));//, null, 2));
	        } else {
	            output.val('JSON browser support required for this demo.');
	        }
			
			 
	    };
		
			
	    // activate Nestable for list 1
	    $('#nestable').nestable({
	        group: 1
	    })
	    .on('change', updateOutput);
	
	    // activate Nestable for list 2
	    $('#nestable2').nestable({
	        group: 1
	    })
	    .on('change', updateOutput);
	
	    // output initial serialised data
	    updateOutput($('#nestable').data('output', $('#templateJson')));
	    
	    $('#nestable-menu').on('click', function(e)
	    {
	        var target = $(e.target),
	            action = target.data('action');
	        if (action === 'expand-all') {
	            $('.dd').nestable('expandAll');
	        }
	        if (action === 'collapse-all') {
	            $('.dd').nestable('collapseAll');
	        }
			
			if (action === 'add-row') {
				//如果未选择Temaplate Type,则不能添加新行
				var value = $("#filename_select").val()
				if(value==''){
					jp.error('select template type please!');
					$("#filename_select").focus();
					//$("#filename_select").click();
					
				}else{
					
				
			     //新增行，置行对象为空
				 edit_obj = null;
				 //每次显示编辑框，重新生成一个编辑对象，防止每次编辑时undo 和redo串错
				 var coder_div = $("#coder-div");
				 var coder = '<textarea id="coder" style="height:500px;"  class="form-control" rows="60"></textarea>';
				 		  
				 coder_div.html(coder);
				 
				 code_editer = CodeMirror.fromTextArea(document.getElementById("coder"), {
				 				 lineNumbers: true,
				 				 autofocus: true,
				 				 matchBrackets: true,
				 				 styleActiveLine: true
				 			 });	
				 code_editer.setSize('auto','400px');
				 $('#row-edit').modal('show')
				 code_editer.setValue('');
				 }
			}
			
	    });
	
	
	    $('#nestable').nestable();
		//默认隐藏编辑框
		$(function () { $('#row-edit').modal('hide')});
	
		$("#row-edit").modal({
				//点击背景不关闭
				backdrop:"static",
				//触发键盘esc事件时不关闭
				keyboard: false
			});
	
	//coder editer
	
	
	});
		
	function delInfo(obj) {
				var tmp = obj;
				var parent = $(obj).parent(".dd3-content").parent(".dd-item").remove();
				updateOutput($('#nestable').data('output', $('#templateJson')));
				
			}

	function editInfo(obj) {
		var value = $("#filename_select").val()
		if(value==''){
			jp.error('select template type please!');
			$("#filename_select").focus();
			//$("#filename_select").click();
			
		}else{
		
			var item = $(obj).parent(".dd3-content").parent(".dd-item");
			var code = '';
			if(item.data().value){
				code=item.data().value
			}
			//每次显示编辑框，重新生成一个编辑对象，防止每次编辑时undo 和redo串错
			var coder_div = $("#coder-div");
			var coder = '<textarea id="coder" style="height:500px;"  class="form-control" rows="60"></textarea>';
					  
			coder_div.html(coder);
			
			code_editer = CodeMirror.fromTextArea(document.getElementById("coder"), {
							 lineNumbers: true,
							 autofocus: true,
							 matchBrackets: true,
							 styleActiveLine: true
						 });	
			code_editer.setSize('auto','400px');
			$('#row-edit').modal('show')
			
			code_editer.setValue(code);
			edit_obj = obj;
		}	
	}
	//更新json数据
	function updateOutput  (e)
		{
			var list   = e.length ? e : $(e.target),
				output = list.data('output');
			
			if (window.JSON) {
				//output.val(window.JSON.stringify(list.nestable('serialize')));//, null, 2));
				output.val(window.JSON.stringify(list.nestable('serialize')));//, null, 2));
			} else {
				output.val('JSON browser support required for this demo.');
			}
			
			 
		};

	//保存指令		
	function saveRow(){
		var temp = code_editer.getValue();
		var temp2;
		//如果edit_obj不为空，则是编辑
		if(edit_obj){
			var item = $(edit_obj).parent(".dd3-content").parent(".dd-item");
			item.data('value',temp);
			var item2 = $(edit_obj).parent(".dd3-content")
			var html = '<a class="del-right" href="javascrip:;" onclick="delInfo(this);" title="删除">Del</a><a class="edit-right" href="javascrip:;" onclick="editInfo(this)" title="增加">Edit</a>';
			var reg = new RegExp("\\n","g");//g,表示全部替换。
			temp=temp.replace(reg,"<br>");
			item2.html(temp+html);
			// 增加input
			updateOutput($('#nestable').data('output', $('#templateJson')));
			$('#row-edit').modal('hide')
			
		}else{
			//新增
		var reg = new RegExp("<","g");//替换小于号，g,表示全部替换。
		temp2=temp.replace(reg,"&lt;");
		reg = new RegExp(">","g");//替换大于号g,表示全部替换。
		temp2=temp2.replace(reg,"&gt;");
		reg = new RegExp("\\n","g");//替换换行符g,表示全部替换。
		temp2=temp2.replace(reg,"<br>");
		
		var html = '<li class="dd-item dd3-item" data-id="1" data-value="'+temp+'" ><div class="dd-handle dd3-handle"></div><div class="dd3-content"><span class="input-value">'+temp2+'</span><a  class="del-right" href="javascrip:;" onclick="delInfo(this);" title="Delete">Del</a><a class="edit-right" href="javascrip:;" onclick="editInfo(this)" title="Edit">Edit</a></div></li>';
		$('#nestable #J_List').append(html);
		updateOutput($('#nestable').data('output', $('#templateJson')));
		
		$('#row-edit').modal('hide')
		}
	}


	function changeFileName(){
		var addTime = Time();
		var value = $("#filename_select").val()
		var text = $("#filename_select").find("option:selected").text();
		//删除所有选项
		$("#list_select")[0].options.length=0;
		$("#file_name_list_select")[0].options.length=0;
		var options="<option value=''>Select...</option>";
		$("#list_select").append(options);
		$("#file_name_list_select").append(options);
		//alert(value)
		if(value!=''){
			//$("#templateName").val(text+' '+addTime);
			//$("#fileName").val(text);
			$("#templateType").val(text);
			$("#dictType").val(value);
			
			$("#template_type").val(value);
		}else{
			//$("#templateName").val('');
			//$("#fileName").val('');
			$("#templateType").val('');
			$("#dictType").val('');
			$("#template_type").val('');
		}
		if(value!=''){
		//load list
		jp.loading();
		jp.post("/system/dict/value/list/byParentType/",$('#searchForm').serialize(),function(data){
		    jp.success('load success');
			for(var i=0 ;i<data.length;i++){
				
				var options="<option value='"+data[i].label+"'>"+data[i].label+"</option>";
				$("#list_select").append(options);
				$("#file_name_list_select").append(options);
				
				//alert(data[i].value);	
			}
			
		    
		});
		}else{
			
			
		}
		
		
	}
	
	function Time() {
	  var now = new Date();
	  var year = now.getFullYear(); //年
	  var month = now.getMonth() + 1; //月
	  var day = now.getDate(); //日
	  var hh = now.getHours(); //时
	  var mm = now.getMinutes(); //分
	  var ss = now.getSeconds(); //秒
	  var clock = year + "_";
	  if (month < 10)
	    clock += "0";
	  clock += month + "_";
	  if (day < 10)
	    clock += "0";
	  clock += day + "_";
	  if (hh < 10)
	    clock += "0";
	  clock += hh + "";
	  if (mm < 10) clock += '0';
	  clock += mm + "";
	  if (ss < 10) clock += '0';
	  clock += ss;
	  return (clock);
	}
	
	
	function save() {
	    var isValidate = jp.validateForm('#inputForm');//校验表单
	    if(!isValidate){
	        return false;
	    }else{
	        jp.loading();
	        jp.post("/system/template/{{method}}/",$('#inputForm').serialize(),function(data){
	            if(data.success){
	                jp.getParent().refresh();
	                var dialogIndex = parent.layer.getFrameIndex(window.name); // 获取窗口索引
	                parent.layer.close(dialogIndex);
	                jp.success(data.msg)
	
	            }else{
	                jp.error(data.msg);
	            }
	        })
	    }
	
	}
	
	function insertInfotree(){
		var selecttext = $("#list_select").val();
		if(selecttext==''){
			jp.error('select info tree please');
			return;
		}
		//alert(selecttext)
		selecttext = '{'+'{'+selecttext+'}'+'}';
		var cursor = code_editer.getCursor();
		code_editer.replaceRange(selecttext,cursor,cursor);
		
	}
	
	function insertToName(){
		var selecttext = $("#file_name_list_select");
		if(selecttext.val()==''){
			jp.error('select value please');
			selecttext.focus();
			return;
		}
		//alert(selecttext)
		selecttext = '{'+'{'+selecttext.val()+'}'+'}';
		//$('#fileName').val(selecttext);
		//var cursor = code_editer.getCursor();
		//code_editer.replaceRange(selecttext,cursor,cursor);
		var txtArea = $("#fileName")[0];
		var content = $('#fileName').val();
		var start = txtArea.selectionStart; //初始位置
		txtArea.value = content.substring(0, txtArea.selectionStart) + selecttext + content.substring(txtArea.selectionEnd, content.length);
		var position = start + selecttext.length;
		$("#fileName").focus();
		txtArea.setSelectionRange(position, position);
		
	}
	
	function insertFloorplan(){
		var selecttext = $("#floorplan").val();
		if(selecttext==''){
			jp.error('select floor plan please');
			return;
		}
		//alert(selecttext)
		selecttext = '{'+'{'+selecttext+'}'+'}';
		
		var cursor = code_editer.getCursor();
		code_editer.replaceRange(selecttext,cursor,cursor);
		
	}
	
	function undo(){
		code_editer.undo();
	}
	
	
	function redo(){
		code_editer.redo();
	}
	
	function moveEnd(obj){
	    obj.focus();
	    var len = obj.value.length;
	    if (document.selection) {
	        var sel = obj.createTextRange();
	        sel.moveStart('character',len);
	        sel.collapse();
	        sel.select();
	    } else if (typeof obj.selectionStart == 'number' && typeof obj.selectionEnd == 'number') {
	        obj.selectionStart = obj.selectionEnd = len;
	    }
	}
	
</script>

</body>
</html>

<!DOCTYPE html>
<html style="overflow-x:auto;overflow-y:auto;">
<head>
    <title>Role Manage</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <meta name="author" content="http://www.jeeplus.org/"/>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=9,IE=10"/>
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Cache-Control" content="no-cache">
    <meta http-equiv="Cache-Control" content="no-store">
    <script>var d = "";</script>
    <link rel="stylesheet" type="text/css" href="{{ static ('/layui/css/layui.css') }}">
    <script type="text/javascript" src="{{ static ('/js/jquery-3.4.1.js') }}"></script>
    <script type="text/javascript" src="{{ static ('/layui/layui.js') }}"></script>
    <meta name="viewport"
          content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    {% include 'base.html' %}
    <script type="text/javascript">

        $(document).ready(function () {
            $('input.i-checks').iCheck({
                checkboxClass: 'icheckbox_square-blue',
                radioClass: 'iradio_square-blue',
                increaseArea: '20%' // optional
            });
        });

    </script>

    <meta name="decorator" content="ani"/>
    <script src="{{ static ('/ani/static/plugin/bootstrapTable/bootstrap-table-zh-CN.js') }}"></script>
    <script src="{{ static ('/ani/static/plugin/bootstrapTable/bootstrap-table-contextmenu.js') }}"></script>
    <script src="{{ static ('/ani/static/plugin/bootstrapTable/tableExport.js') }}"></script>
    <script src="{{ static ('/ani/static/plugin/bootstrapTable/bootstrap-table-export.js') }}"></script>
    <script>
        $(document).ready(function () {
            $('#table').bootstrapTable({
                //请求方法
                method: 'post',
                //类型json
                dataType: "json",
                contentType: "application/x-www-form-urlencoded",
                //是否显示行间隔色
                striped: true,
                //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
                cache: false,
                showSearch: true,
                //显示刷新按钮
                showRefresh: true,
                //显示切换手机试图按钮
                showToggle: true,
                //显示 内容列下拉框
                showColumns: true,
                //显示切换分页按钮
                //是否显示分页（*）
                pagination: true,
                //排序方式
                sortOrder: "asc",
                //初始化加载第一页，默认第一页
                pageNumber: 1,
                //每页的记录行数（*）
                pageSize: 10,
                //可供选择的每页的行数（*）
                pageList: [10, 25, 50, 100],
                //这个接口需要处理bootstrap table传递的固定参数,并返回特定格式的json数据
                url: "/catalog/catalog_info/all_info/",
                //默认值为 'limit',传给服务端的参数为：limit, offset, search, sort, order Else
                //queryParamsType:'',
                ////查询参数,每次调用是会带上这个参数，可自定义
                queryParams: function (params) {
                    var searchParam = $("#searchForm").serializeJSON();
                    searchParam.pageNo = params.limit === undefined ? "1" : params.offset / params.limit + 1;
                    searchParam.pageSize = params.limit === undefined ? -1 : params.limit;
                    searchParam.orderBy = params.sort === undefined ? "" : params.sort + " " + params.order;
                    return searchParam;
                },
                onShowSearch: function () {
                    $("#search-collapse").slideToggle();
                },
                //分页方式：client客户端分页，server服务端分页（*）
                sidePagination: "server",
                contextMenuTrigger: "right",//pc端 按右键弹出菜单
                contextMenuTriggerMobile: "press",//手机端 弹出菜单，click：单击， press：长按。
                contextMenu: '#context-menu',
                onContextMenuItem: function (row, $el) {
                    if ($el.data("item") == "edit") {
                        edit(row.id);
                    } else if ($el.data("item") == "delete") {
                        del(row.id);

                    }
                },
                columns: [
                    {
                        field: 'priority',
                        title: 'Priority',
                        align: 'center',
                    }, {
                        field: 'id',
                        title: 'Lot Info ID',
                        align: 'center',
                    }, {
                        field: 'tool_id',
                        title: 'Tool ID',
                        align: 'center',
                    }, {
                        field: 'lot_id',
                        title: 'Lot ID',
                        align: 'center',
                    }, {
                        field: 'mes_carrier_id',
                        title: 'Carrier ID',
                        align: 'center',
                    }, {
                        field: 'mask_name',
                        title: 'Prod ID',
                        align: 'center',
                    }, {
                        field: 'security',
                        title: 'Security',
                        align: 'center',
                    }, {
                        field: 'mes_customer_code',
                        title: 'Customer',
                        align: 'center',
                    }, {
                        field: 'rule',
                        title: 'Tech',
                        align: 'center',
                    }, {
                        field: 'grade',
                        title: 'Grade',
                        align: 'center',
                    }, {
                        field: 'clip',
                        title: 'CLIP',
                        align: 'center',
                    }, {
                        field: 'ratio',
                        title: 'Ratio',
                        align: 'center',
                    }, {
                        field: 'mes_operation_id',
                        title: 'PDID',
                        align: 'center',
                    }, {
                        field: 'blank',
                        title: 'Blank',
                        align: 'center',
                    }, {
                        field: 'writer_create_file_status',
                        title: 'Create File',
                        align: 'center',
                        formatter: function operateFormatter(value, row, index) {
                            const writer_create_file_status = row.writer_create_file_status;
                            if (writer_create_file_status === 0) {
                                return "-"
                            } else if (writer_create_file_status === 1) {
                                return "Creating"
                            } else if (writer_create_file_status === 2) {
                                return "failed"
                            } else if (writer_create_file_status === 3) {
                                return "Success"
                            }
                        },
                    }, {
                        field: 'ftp_upload_status',
                        title: 'FTP',
                        align: 'center',
                        events: {
                            'click .progress': function (e, value, row, index) {
                                jp.openViewDialog('Upload Progress', '/catalog/catalog_info/upload_progress/?id=' + row.id, '800px', '650px');
                            },
                        },
                        formatter: function operateFormatter(value, row, index) {
                            const ftp_upload_status = row.ftp_upload_status;
                            if (ftp_upload_status === 0) {
                                return "-"
                            } else if (ftp_upload_status === 1) {
                                return [
                                    {% if '/catalog/catalog_info/upload_progress/' in request.session.MASK_DP_SESSION_CURRENT_USER_PERMISSION_LIST %}
                                        '<a href="#" class="progress" title="Upload Progress" >Uploading</a>',
                                    {% endif %}
                                ].join('')
                            } else if (ftp_upload_status === 2) {
                                return "failed"
                            } else if (ftp_upload_status === 3) {
                                return "Success"
                            }
                        },
                    }, {
                        field: 'catalog_status',
                        title: 'Catalog',
                        align: 'center',
                        events: {
                            'click .catalog': function (e, value, row, index) {
                                jp.confirm('Are you sure you want to catalog', function () {
                                    jp.loading();
                                    $.ajax({
                                        url: '/catalog/catalog_info/start_catalog/',
                                        method: 'post',
                                        data: {
                                            'lot_info_id': row.id,
                                        },
                                        async: false,
                                        success: function (data) {
                                            if (data.success) {
                                                jp.success('Catalog success');
                                                refresh();
                                            } else {
                                                jp.error(data.message);

                                            }
                                        }
                                    })
                                })
                            },
                        },
                        formatter: function operateFormatter(value, row, index) {
                            const catalog_status = row.catalog_status;
                            const ftp_upload_status = row.ftp_upload_status;
                            if ((ftp_upload_status === 3) && ((catalog_status === 0) || (catalog_status === 2))) {
                                return [
                                    {% if '/catalog/catalog_info/start_catalog/' in request.session.MASK_DP_SESSION_CURRENT_USER_PERMISSION_LIST %}
                                        '<a href="#" class="catalog" title="Catalog" >Catalog</a>',
                                    {% endif %}
                                ].join('');
                            } else if (catalog_status === 0) {
                                return "-"
                            } else if (catalog_status === 1) {
                                return "Creating"
                            } else if (catalog_status === 2) {
                                return "failed"
                            } else if (catalog_status === 3) {
                                return "Reg Checking"
                            } else if (catalog_status === 4) {
                                {#return "Reg failed"#}
                                return [
                                    {% if '/catalog/catalog_info/start_catalog/' in request.session.MASK_DP_SESSION_CURRENT_USER_PERMISSION_LIST %}
                                        '<a href="#" class="catalog" title="Catalog" >Reg failed</a>',
                                    {% endif %}
                                ].join('');
                            } else if (catalog_status === 5) {
                                return "Success"
                            }
                        },
                    }, {
                        field: 'writer_op_status',
                        title: 'OP Status',
                        align: 'center',
                        events: {
                            'click .operation_start': function (e, value, row, index) {
                                {#$.ajax({#}
                                {#    url: '/catalog/catalog_info/catalog_op_start/',#}
                                {#    method: 'post',#}
                                {#    data: {#}
                                {#        'lot_info_id': row.id,#}
                                {#    },#}
                                {#    async: false,#}
                                {#    success: function (data) {#}
                                {#        if (data.success) {#}
                                {#            jp.success(data.message);#}
                                {#            refresh();#}
                                {#        } else {#}
                                {#            jp.error(data.message);#}
                                {#        }#}
                                {#    }#}
                                {# });#}
                                jp.openSaveDialog('OP Start', '/catalog/catalog_info/catalog_op_operation/?lot_info_id=' + row.id + '&&operation=start', '450px', '250px');
                            },
                            'click .operation_comp': function (e, value, row, index) {
                                {#$.ajax({#}
                                {#    url: '/catalog/catalog_info/catalog_op_comp/',#}
                                {#    method: 'post',#}
                                {#    data: {#}
                                {#        'lot_info_id': row.id,#}
                                {#    },#}
                                {#    async: false,#}
                                {#    success: function (data) {#}
                                {#        if (data.success) {#}
                                {#            jp.success('Catalog success');#}
                                {#            refresh();#}
                                {#        } else {#}
                                {#            jp.error(data.message);#}
                                {##}
                                {#        }#}
                                {#    }#}
                                {# })#}
                                jp.openSaveDialog('OP Complete', '/catalog/catalog_info/catalog_op_operation/?lot_info_id=' + row.id + '&&operation=comp', '450px', '250px');
                            }
                        },
                        formatter: function operateFormatter(value, row, index) {
                            const catalog_status = row.catalog_status;
                            const writer_op_status = row.writer_op_status;
                            const mes_operation_number = row.mes_operation_number;
                            if ((catalog_status === 5) && (writer_op_status === 0) && (mes_operation_number === "200.200")) {
                                return '<a href="#" class="operation_start" title="OP Start" >Start</a>'
                            } else if ((catalog_status === 5) && (writer_op_status === 1)) {
                                return '<a href="#" class="operation_comp" title="OP Comp" >Running</a>'
                            } else if (writer_op_status === 3) {
                                return "Complete"
                            } else {
                                return "-"
                            }
                        },
                    }, {
                        field: 'operation',
                        title: 'Operation',
                        align: 'center',
                        events: {
                            'click .error_list': function (e, value, row, index) {
                                jp.openViewDialog('Error List', '/catalog/catalog_info/error_list/?lot_info_id=' + row.id, '800px', '650px');
                            },
                            'click .move_back': function (e, value, row, index) {
                                jp.confirm('Are you sure you want to move back', function () {
                                    jp.loading();
                                    $.ajax({
                                        url: '/catalog/catalog_info/catalog_move_back/',
                                        method: 'post',
                                        data: {
                                            'lot_info_id': row.id,
                                        },
                                        async: false,
                                        success: function (data) {
                                            if (data.success) {
                                                jp.success('move back success');
                                                refresh();
                                            } else {
                                                jp.error(data.message);
                                            }
                                        }
                                    })
                                })
                            },
                            'click .change': function (e, value, row, index) {
                                jp.confirm('Are you sure you want to change', function () {
                                    jp.loading();
                                    $.ajax({
                                        url: '/catalog/catalog_info/catalog_change/',
                                        method: 'post',
                                        data: {
                                            'lot_info_id': row.id,
                                        },
                                        async: false,
                                        success: function (data) {
                                            if (data.success) {
                                                jp.success('change success');
                                                refresh();
                                            } else {
                                                jp.error(data.message);
                                            }
                                        }
                                    })
                                })
                            },
                            'click .operation_cancel': function (e, value, row, index) {
                                $.ajax({
                                    url: '/catalog/catalog_info/catalog_op_cancel/',
                                    method: 'post',
                                    data: {
                                        'lot_info_id': row.id,
                                    },
                                    async: false,
                                    success: function (data) {
                                        if (data.success) {
                                            jp.success(data.message);
                                            refresh();
                                        } else {
                                            jp.error(data.message);

                                        }
                                    }
                                })
                            }
                        },
                        formatter: function operateFormatter(value, row, index) {
                            const writer_create_file_status = row.writer_create_file_status;
                            const ftp_upload_status = row.ftp_upload_status;
                            const catalog_status = row.catalog_status;
                            const writer_op_status = row.writer_op_status;
                            const mes_operation_number = row.mes_operation_number;
                            console.log(parseFloat(mes_operation_number));
                            if (parseFloat(mes_operation_number) < 200.200) {
                                if ((catalog_status === 0) && (ftp_upload_status === 0)) {
                                    return [
                                        {% if '/catalog/catalog_info/error_list/' in request.session.MASK_DP_SESSION_CURRENT_USER_PERMISSION_LIST %}
                                            '<a href="#" class="error_list" title="Error List" ><i class="fa fa-book"></i></a>',
                                        {% endif %}
                                    ].join('')
                                } else if ((catalog_status === 0) && (ftp_upload_status === 3)) {
                                    return [
                                        {% if '/catalog/catalog_info/error_list/' in request.session.MASK_DP_SESSION_CURRENT_USER_PERMISSION_LIST %}
                                            '<a href="#" class="error_list" title="Error List" ><i class="fa fa-book"></i></a>',
                                        {% endif %}
                                        '&nbsp;',
                                        '&nbsp;',
                                        {% if '/catalog/catalog_info/catalog_change/' in request.session.MASK_DP_SESSION_CURRENT_USER_PERMISSION_LIST %}
                                            '<a href="#" class="change" title="change" ><i class="fa fa-exchange"></i></a>',
                                        {% endif %}
                                    ].join('')
                                } else if (((catalog_status === 4) || (catalog_status === 5)) && (writer_op_status === 0)) {
                                    return [
                                        {% if '/catalog/catalog_info/error_list/' in request.session.MASK_DP_SESSION_CURRENT_USER_PERMISSION_LIST %}
                                            '<a href="#" class="error_list" title="Error List" ><i class="fa fa-book"></i></a>',
                                        {% endif %}
                                        '&nbsp;',
                                        '&nbsp;',
                                        {% if '/catalog/catalog_info/catalog_move_back/' in request.session.MASK_DP_SESSION_CURRENT_USER_PERMISSION_LIST %}
                                            '<a href="#" class="move_back" title="move_back" ><i class="fa fa-undo"></i></a>',
                                        {% endif %}
                                    ].join('');
                                }
                            } else if ((mes_operation_number === "200.200") && (writer_op_status === 1)) {
                                if (writer_op_status === 1) {
                                    return [
                                        {% if '/catalog/catalog_info/error_list/' in request.session.MASK_DP_SESSION_CURRENT_USER_PERMISSION_LIST %}
                                            '<a href="#" class="error_list" title="Error List" ><i class="fa fa-book"></i></a>',
                                        {% endif %}
                                        '&nbsp;',
                                        '&nbsp;',
                                        {#                                        {% if '/catalog/catalog_info/catalog_op_cancel/' in request.session.MASK_DP_SESSION_CURRENT_USER_PERMISSION_LIST %}#}
                                        {#                                            '<a href="#" class="operation_cancel" title="operation_cancel" ><i class="fa fa-close"></i></a>',#}
                                        {#                                        {% endif %}#}
                                    ].join('');
                                } else if ((writer_create_file_status === 1) || (ftp_upload_status === 1) ||
                                    (catalog_status === 1) || (catalog_status === 3) || (writer_op_status === 1)) {
                                    return [
                                        {% if '/catalog/catalog_info/error_list/' in request.session.MASK_DP_SESSION_CURRENT_USER_PERMISSION_LIST %}
                                            '<a href="#" class="error_list" title="Error List" ><i class="fa fa-book"></i></a>',
                                        {% endif %}
                                    ].join('');
                                }
                            }
                        }
                    }]
            });

            if (navigator.userAgent.match(/(iPhone|iPod|Android|ios)/i)) {//如果是移动端，默认关闭tab
                $('#table').bootstrapTable("toggleView");
            }

            $('#table').on('check.bs.table uncheck.bs.table load-success.bs.table ' +
                'check-all.bs.table uncheck-all.bs.table', function () {
                $('#remove').prop('disabled', !$('#table').bootstrapTable('getSelections').length);
                $('#edit, #auth').prop('disabled', $('#table').bootstrapTable('getSelections').length != 1);
            });

            $("#search").click("click", function () {// 绑定查询按扭
                $('#table').bootstrapTable('refresh');
            });
            $("#reset").click("click", function () {// 绑定查询按扭
                $('#table').bootstrapTable('refresh');
            });

        });

        function getIdSelections() {
            return $.map($("#table").bootstrapTable('getSelections'), function (row) {
                return row.id
            });
        }

        function refresh() {
            $('#table').bootstrapTable('refresh');
        }

    </script>
</head>
<body id="" class="" style="">

<div class="wrapper wrapper-content">
    <div class="panel panel-primary">
        <div class="panel-heading">
            <h3 class="panel-title">File Info List</h3>
        </div>
        <div class="panel-body">
            <div class="row">
                <div id="left" class="col-sm-12">
                    <!-- 搜索 -->
                    <div id="search-collapse" class="collapse">
                        <div class="accordion-inner">
                            <form id="searchForm" class="form form-horizontal well clearfix" method="post">
                                <input type="hidden" name="tool_id" value="{{ tool_id }}">
                                <div class="col-xs-12 col-sm-6 col-md-4">
                                    <div style="margin-top:26px">
                                        <a id="search" class="btn btn-primary btn-rounded  btn-bordered btn-sm"><i
                                                class="fa fa-search"></i> Query</a>
                                        <a id="reset" class="btn btn-primary btn-rounded  btn-bordered btn-sm"><i
                                                class="fa fa-refresh"></i> Reset</a>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- 工具栏 -->
                    <div id="toolbar">
                    </div>
                    <!-- 工具栏结束 -->

                    <!-- 表格 -->
                    <table id="table"
                           data-toolbar="#toolbar"
                           data-id-field="id">
                    </table>

                    <!-- context menu -->
                    <ul id="context-menu" class="dropdown-menu">
                        <li data-item="edit"><a>编辑</a></li>
                        <li data-item="delete"><a>删除</a></li>
                        <li data-item="action1"><a>取消</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>

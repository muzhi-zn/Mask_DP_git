


<!DOCTYPE html>
<html style="overflow-x:auto;overflow-y:auto;">
	<head>
		<title>Payment Check</title>
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />

		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=9,IE=10" />
		<meta http-equiv="Expires" content="0">
		<meta http-equiv="Cache-Control" content="no-cache">
		<meta http-equiv="Cache-Control" content="no-store">
		<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
		{% include 'base.html' %}
		<script type="text/javascript">
			$(document).ready(function() {
				$('input.i-checks').iCheck({
					checkboxClass: 'icheckbox_square-lynch',
					radioClass: 'iradio_square-lynch',
					increaseArea: '20%' // optional
				});
			});
		</script>
		<meta name="decorator" content="ani" />
		<script type="text/javascript">
			$(document).ready(function() {
				var token = $('input[name=csrfmiddlewaretoken]').val();

				//表格初始化
				$('#table').bootstrapTable({
					//请求方法
					method: 'post',
					//类型json
					dataType: "json",
					contentType: "application/x-www-form-urlencoded",
					//是否显示行间隔色
					striped: true,
					//是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）     
					cache: false,
					//显示检索按钮
					showSearch: true,
					//显示刷新按钮
					showRefresh: true,
					//显示切换手机试图按钮
					showToggle: true,
					//显示 内容列下拉框
					showColumns: true,
					//显示切换分页按钮
					showPaginationSwitch: true,
					//是否显示分页（*）  
					pagination: true,
					//排序方式 
					sortOrder: "asc",
					//初始化加载第一页，默认第一页
					pageNumber: 1,
					//每页的记录行数（*）   
					pageSize: 10,
					//可供选择的每页的行数（*）    
					pageList: [10, 25, 50, 100],
					//这个接口需要处理bootstrap table传递的固定参数,并返回特定格式的json数据  
					url: "/jdv/payment_check/list/",
					//默认值为 'limit',传给服务端的参数为：limit, offset, search, sort, order Else
					//queryParamsType:'',   
					////查询参数,每次调用是会带上这个参数，可自定义                         
					queryParams: function(params) {
						var searchParam = $("#searchForm").serializeJSON();
						//alert(searchParam.pageNo)
						searchParam.pageNo = params.limit === undefined ? "1" : params.offset / params.limit + 1;
						searchParam.pageSize = params.limit === undefined ? -1 : params.limit;
						searchParam.orderBy = params.sort === undefined ? "" : params.sort + " " + params.order;
						csrfmiddlewaretoken = token;
						return searchParam;
					},
					data: {
						csrfmiddlewaretoken: token
					},
					onShowSearch: function() {
						$("#search-collapse").slideToggle();
					},
					//分页方式：client客户端分页，server服务端分页（*）
					sidePagination: "server",
					contextMenuTrigger: "right", //pc端 按右键弹出菜单
					contextMenuTriggerMobile: "press", //手机端 弹出菜单，click：单击， press：长按。
					contextMenu: '#context-menu',
					onContextMenuItem: function(row, $el) {
						if ($el.data("item") == "edit") {
							edit(row.id);
						} else if ($el.data("item") == "delete") {
							deleteAll(row.id);
						}
					},
					onClickRow: function(row, $el) {},
					columns: [
						{
							checkbox: true
						},
						{
							field: 'tip_no',
							title: 'Tip No',
							align: 'center'
						}, {
							align: 'center',
							field: 'product_name',
							title: 'Product Name'
						}, {
					        align: 'center',
                            field: 'mask_name',
                            title: 'Layer Name',
                            formatter: function (value, row, index) {
					            console.log(value)
                                return (value + "").split("-")[1]
                            }
                        }, {
							align: 'center',
							field: 'lot_id',
							title: 'lot'
						}, {
							align: 'center',
							field: 'lot_owner_name',
							title: 'Owner Name'
						}, {
							align: 'center',
							field: 'expire_date',
							title: 'Expire Date',
                            formatter: function(value, row, index){
                                return value.replace('T', ' ').replace('Z', '')
                            }
						}, {
							align: 'center',
							field: 'payment_status',
							title: 'Payment Status',
							formatter:function(value,row,index){
								if(row.payment_status == 0){
									return '<button type="button" class="layui-btn" onclick="paymentSuccess('+row.id+',\''+ row.lot_id+'\')">Payment Success</button>';
								}else if(row.payment_status == 1){
									return '<label style="color:green">paid</label>'
								}
							}
						}
					]

				});


				if (navigator.userAgent.match(/(iPhone|iPod|Android|ios)/i)) { //如果是移动端
					$('#table').bootstrapTable("toggleView");
				}

				$('#table').on('check.bs.table uncheck.bs.table load-success.bs.table ' +
					'check-all.bs.table uncheck-all.bs.table',
					function() {
						$('#remove').prop('disabled', !$('#table').bootstrapTable('getSelections').length);
						$('#edit').prop('disabled', $('#table').bootstrapTable('getSelections').length != 1);
					});
				$("#search").click("click", function() { // 绑定查询按扭
					$('#table').bootstrapTable('refresh');
				});
				$("#reset").click("click", function() { // 绑定查询按扭
					$("#tip_no").val("");
					$("#product_name").val("");
					$("#lot").val("");
					//$("#searchForm  select").val("");
					$('#table').bootstrapTable('refresh');
				});
			});

			function getIdSelections() {
				return $.map($("#table").bootstrapTable('getSelections'), function(row) {
					return row.id
				});
			}

			function refresh() {
				$('#table').bootstrapTable('refresh');
			}

			function paymentSuccess(id, lot_id){
			    console.log(lot_id)
				layer.confirm('Are you sure this lot is paid?',{
					title:'info',
					btn:['yes','cancel']
				},function(){
					$.ajax({
						url:'/jdv/payment_check/mark/',
						method:'post',
						data:{
							'id': id,
                            'lot_id': lot_id,
							'csrfmiddlewaretoken':$('input[name=csrfmiddlewaretoken]').val()
						},
						dataType:'json',
						success:function(data){
							layer.msg(data.message)
							$('#table').bootstrapTable('refresh');
						}
					})
				},function(index){
					layer.close(index)
				})
			}
		</script>

	</head>
	<body id="" class="" style="">
		<form id="inputForm"><input type ="hidden" name ="csrfmiddlewaretoken" value ="{{csrf_token}}"></form>
		<div class="wrapper wrapper-content">
			<div class="panel panel-primary">
				<div class="panel-heading">
					<h3 class="panel-title">Payment Check List</h3>
				</div>
				<div class="panel-body">
					<div class="row">
						<div class="col-sm-12 col-md-12 animated fadeInRight">
							<!-- 搜索框-->
							<div id="search-collapse" class="collapse">
								<div class="accordion-inner">
									<form id="searchForm" class="form form-horizontal well clearfix" action="/wrong_form/" method="post">
										<input type ="hidden" name ="csrfmiddlewaretoken" value ="{{csrf_token}}">
										<div class="col-xs-12 col-sm-3 col-md-3">
											<label class="label-item single-overflow pull-left" title="Tipno：">Product_Name：</label>
											<input id="product_name" name="product_name" class=" form-control input-sm" type="text" value="" maxlength="50" />
										</div>
										<div class="col-xs-12 col-sm-3 col-md-3">
											<label class="label-item single-overflow pull-left" title="Tipno：">Tip_No：</label>
											<input id="tip_no" name="tip_no" class=" form-control input-sm" type="text" value="" maxlength="50" />
										</div>
										<div class="col-xs-12 col-sm-3 col-md-3">
											<label class="label-item single-overflow pull-left" title="Tipno：">Lot：</label>
											<input id="lot" name="lot" class=" form-control input-sm" type="text" value="" maxlength="50" />
										</div>
										<div class="col-xs-12 col-sm-3 col-md-3">
											<div style="margin-top:26px">
												<a id="search" class="btn btn-primary btn-rounded  btn-bordered btn-sm"><i class="fa fa-search"></i> Query</a>
												<a id="reset" class="btn btn-primary btn-rounded  btn-bordered btn-sm"><i class="fa fa-refresh"></i> Reset</a>
											</div>
										</div>
									</form>
								</div>
							</div><!-- 搜索框结束 -->
							<!-- 表格 -->
							<table id="table" data-toolbar="#toolbar">
							</table>
							<!-- context menu -->
							<!-- <ul id="context-menu" class="dropdown-menu">
								<li data-item="edit"><a>编辑</a></li>
								<li data-item="delete"><a>删除</a></li>
								<li data-item="cancel"><a>取消</a></li>
							</ul> -->
						</div>
					</div>
				</div>
			</div>
		</div>


	</body>
</html>
